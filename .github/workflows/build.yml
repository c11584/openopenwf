name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        configuration: [ Release ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: 'latest'
    
    - name: Restore NuGet packages
      run: nuget restore openopenwf.sln
    
    - name: Build solution
      run: msbuild openopenwf.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=x64 /p:OutDir="${{ github.workspace }}/x64/${{ matrix.configuration }}" /p:OutputPath="${{ github.workspace }}/x64/${{ matrix.configuration }}"

    - name: Debug - Check build output directory
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        echo "Checking build output directory: $outputDir"
        if (Test-Path "${{ github.workspace }}/$outputDir") {
          echo "Directory exists, listing contents:"
          Get-ChildItem -Path "${{ github.workspace }}/$outputDir" -Recurse
        } else {
          echo "Directory does not exist!"
        }

    - name: Create package
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        
        # Create package directory
        New-Item -ItemType Directory -Path "${{ github.workspace }}/packages/${packageName}" -Force
        
        # Copy all files from output directory
        echo "Running file copy command:"
        echo "Source: ${{ github.workspace }}/${outputDir}/*"
        echo "Destination: ${{ github.workspace }}/packages/${packageName}"
        Copy-Item -Path "${{ github.workspace }}/${outputDir}/*" -Destination "${{ github.workspace }}/packages/${packageName}" -Recurse -Verbose
        
        # Create ZIP archive
        echo "Creating ZIP archive:"
        echo "Source: ${{ github.workspace }}/packages/${packageName}"
        echo "Destination: ${{ github.workspace }}/packages/${packageName}.zip"
        Compress-Archive -Path "${{ github.workspace }}/packages/${packageName}" -DestinationPath "${{ github.workspace }}/packages/${packageName}.zip" -Verbose

        # Debug - Check package directory
        echo "Checking package directory: packages/${packageName}"
        if (Test-Path "${{ github.workspace }}/packages/${packageName}") {
          echo "Directory exists, listing contents:"
          Get-ChildItem -Path "${{ github.workspace }}/packages/${packageName}" -Recurse
        } else {
          echo "Directory does not exist!"
        }
    
    - name: Install NSIS
      run: choco install nsis -y
    
    - name: Create NSIS script
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        $appName = "openopenwf"
        $appVersion = "1.0.0"
        $githubWorkspace = "${{ github.workspace }}"
        
        # Debug - Show variables for NSIS script generation
        echo "NSIS Script Generation Variables:"
        echo "packageName: $packageName"
        echo "githubWorkspace: $githubWorkspace"
        echo "OutputDir: $outputDir"
        
        # Check package directory with Windows path format
        $packageDir = "$githubWorkspace\packages\$packageName"
        echo "Checking if package directory exists (Windows format): $packageDir"
        if (Test-Path $packageDir) {
          echo "Directory exists, listing contents:"
          Get-ChildItem -Path $packageDir -Recurse
          echo "Count of files in package directory: $(Get-ChildItem -Path $packageDir -Recurse | Where-Object { -not $_.PSIsContainer } | Measure-Object | Select-Object -ExpandProperty Count)"
        } else {
          echo "Directory does not exist!"
          
          # Check if parent directory exists
          $parentDir = Split-Path -Parent $packageDir
          echo "Checking parent directory: $parentDir"
          if (Test-Path $parentDir) {
            echo "Parent directory exists, listing contents:"
            Get-ChildItem -Path $parentDir -Recurse
          } else {
            echo "Parent directory does not exist!"
          }
        }
        
        # Create NSIS script content
        $nsisContent = '; openopenwf Installer' + "`n"
        $nsisContent += '; Generated by GitHub Actions' + "`n`n"
        $nsisContent += '!include "MUI2.nsh"' + "`n`n"
        $nsisContent += '; Basic Settings' + "`n"
        $nsisContent += 'Name "' + $appName + '"' + "`n"
        $nsisContent += 'OutFile "' + $githubWorkspace + '/packages/' + $packageName + '-setup.exe"' + "`n"
        $nsisContent += 'InstallDir "$PROGRAMFILES64\\' + $appName + '"' + "`n"
        $nsisContent += 'RequestExecutionLevel admin' + "`n`n"
        $nsisContent += '; Modern UI Settings' + "`n"
        $nsisContent += '!define MUI_ABORTWARNING' + "`n`n"
        $nsisContent += '; Pages' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_WELCOME' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_LICENSE "' + $githubWorkspace + '/LICENSE"' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_DIRECTORY' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_INSTFILES' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_FINISH' + "`n`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_WELCOME' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_CONFIRM' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_INSTFILES' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_FINISH' + "`n`n"
        $nsisContent += '; Language' + "`n"
        $nsisContent += '!insertmacro MUI_LANGUAGE "English"' + "`n`n"
        $nsisContent += 'Section "MainSection" SEC01' + "`n"
        $nsisContent += '  SetOutPath "$INSTDIR"' + "`n`n"
        $nsisContent += '  ; Copy all files from the package directory' + "`n"
        $nsisContent += '  File /r "' + $githubWorkspace.Replace('/', '\\') + '\\packages\\' + $packageName + '\\*"' + "`n`n"
        $nsisContent += '  ; Create desktop shortcut' + "`n"
        $nsisContent += '  CreateShortCut "$DESKTOP\\' + $appName + '.lnk" "$INSTDIR\\openopenlauncher.exe"' + "`n`n"
        $nsisContent += '  ; Create start menu shortcut' + "`n"
        $nsisContent += '  CreateDirectory "$SMPROGRAMS\\' + $appName + '"' + "`n"
        $nsisContent += '  CreateShortCut "$SMPROGRAMS\\' + $appName + '\\' + $appName + '.lnk" "$INSTDIR\\openopenlauncher.exe"' + "`n"
        $nsisContent += '  CreateShortCut "$SMPROGRAMS\\' + $appName + '\\Uninstall.lnk" "$INSTDIR\\uninstall.exe"' + "`n"
        $nsisContent += 'SectionEnd' + "`n`n"
        $nsisContent += 'Section "Uninstall"' + "`n"
        $nsisContent += '  ; Delete desktop shortcut' + "`n"
        $nsisContent += '  Delete "$DESKTOP\\' + $appName + '.lnk"' + "`n`n"
        $nsisContent += '  ; Delete start menu shortcuts' + "`n"
        $nsisContent += '  Delete "$SMPROGRAMS\\' + $appName + '\\' + $appName + '.lnk"' + "`n"
        $nsisContent += '  Delete "$SMPROGRAMS\\' + $appName + '\\Uninstall.lnk"' + "`n"
        $nsisContent += '  RMDir "$SMPROGRAMS\\' + $appName + '"' + "`n`n"
        $nsisContent += '  ; Delete all files except uninstaller' + "`n"
        $nsisContent += '  Delete /r "$INSTDIR\\*.*"' + "`n"
        $nsisContent += '  ; Remove any subdirectories' + "`n"
        $nsisContent += '  RMDir /r "$INSTDIR\\*"' + "`n"
        $nsisContent += '  ; Remove main directory' + "`n"
        $nsisContent += '  RMDir "$INSTDIR"' + "`n"
        $nsisContent += 'SectionEnd' + "`n`n"
        $nsisContent += '; Generate uninstaller' + "`n"
        $nsisContent += 'WriteUninstaller "$INSTDIR\\uninstall.exe"' + "`n"
        
        # Write NSIS script to file
        $nsisContent | Out-File -FilePath "${{ github.workspace }}/packages/setup.nsi" -Encoding ASCII
    
    - name: Build installer with NSIS
      run: |
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        $githubWorkspace = "${{ github.workspace }}"
        
        # Debug - Show variables for NSIS build
        echo "NSIS Build Variables:"
        echo "packageName: $packageName"
        echo "githubWorkspace: $githubWorkspace"
        echo "NSIS script path: $githubWorkspace/packages/setup.nsi"
        echo "Checking NSIS script content:"
        Get-Content "$githubWorkspace/packages/setup.nsi"
        
        # Refresh environment variables after Chocolatey install
        refreshenv
        # Use full path to makensis to ensure it's found
        & "C:\Program Files (x86)\NSIS\makensis.exe" "$githubWorkspace/packages/setup.nsi"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openopenwf-${{ matrix.configuration }}
        path: |
          ${{ github.workspace }}/packages/*.zip
          ${{ github.workspace }}/packages/*-setup.exe
        retention-days: 14

  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ${{ github.workspace }}/artifacts
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.workspace }}/artifacts/**/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}