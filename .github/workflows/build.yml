name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        configuration: [ Debug, Release ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: 'latest'
    
    - name: Restore NuGet packages
      run: nuget restore openopenwf.sln
    
    - name: Build solution
      run: msbuild openopenwf.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=x64
    
    - name: Create package
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        
        # Create package directory
        New-Item -ItemType Directory -Path "${{ github.workspace }}/packages/${packageName}" -Force
        
        # Copy all files from output directory
        Copy-Item -Path "${{ github.workspace }}/${outputDir}/*" -Destination "${{ github.workspace }}/packages/${packageName}" -Recurse
        
        # Create ZIP archive
        Compress-Archive -Path "${{ github.workspace }}/packages/${packageName}" -DestinationPath "${{ github.workspace }}/packages/${packageName}.zip"
    
    - name: Install NSIS
      run: choco install nsis -y
    
    - name: Create NSIS script
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        $appName = "openopenwf"
        $appVersion = "1.0.0"
        
        $nsisScript = @"
; openopenwf Installer
; Generated by GitHub Actions

!include "MUI2.nsh"

; Basic Settings
Name "${appName}"
OutFile "${{ github.workspace }}/packages/${packageName}-setup.exe"
InstallDir "$PROGRAMFILES64\${appName}"
RequestExecutionLevel admin

; Modern UI Settings
!define MUI_ABORTWARNING

; Pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "${{ github.workspace }}/LICENSE"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_WELCOME
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

; Language
!insertmacro MUI_LANGUAGE "English"

Section "MainSection" SEC01
  SetOutPath "$INSTDIR"
  
  ; Copy all files from the output directory
  File /r "${{ github.workspace }}/${outputDir}/*"
  
  ; Create desktop shortcut
  CreateShortCut "$DESKTOP\${appName}.lnk" "$INSTDIR\openopenlauncher.exe"
  
  ; Create start menu shortcut
  CreateDirectory "$SMPROGRAMS\${appName}"
  CreateShortCut "$SMPROGRAMS\${appName}\${appName}.lnk" "$INSTDIR\openopenlauncher.exe"
  CreateShortCut "$SMPROGRAMS\${appName}\Uninstall.lnk" "$INSTDIR\uninstall.exe"
SectionEnd

Section "Uninstall"
  ; Delete desktop shortcut
  Delete "$DESKTOP\${appName}.lnk"
  
  ; Delete start menu shortcuts
  Delete "$SMPROGRAMS\${appName}\${appName}.lnk"
  Delete "$SMPROGRAMS\${appName}\Uninstall.lnk"
  RMDir "$SMPROGRAMS\${appName}"
  
  ; Delete application files
  RMDir /r "$INSTDIR"
SectionEnd

; Generate uninstaller
WriteUninstaller "$INSTDIR\uninstall.exe"
"@
        
        $nsisScript | Out-File -FilePath "${{ github.workspace }}/packages/setup.nsi" -Encoding ASCII
    
    - name: Build installer with NSIS
      run: |
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        makensis "${{ github.workspace }}/packages/setup.nsi"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: openopenwf-${{ matrix.configuration }}
        path: |
          ${{ github.workspace }}/packages/*.zip
          ${{ github.workspace }}/packages/*-setup.exe
        retention-days: 14

  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: ${{ github.workspace }}/artifacts
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.workspace }}/artifacts/**/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}