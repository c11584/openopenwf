name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        configuration: [ Debug, Release ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: 'latest'
    
    - name: Restore NuGet packages
      run: nuget restore openopenwf.sln
    
    - name: Build solution
      run: msbuild openopenwf.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=x64
    
    - name: Create package
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        
        # Create package directory
        New-Item -ItemType Directory -Path "${{ github.workspace }}/packages/${packageName}" -Force
        
        # Copy all files from output directory
        Copy-Item -Path "${{ github.workspace }}/${outputDir}/*" -Destination "${{ github.workspace }}/packages/${packageName}" -Recurse
        
        # Create ZIP archive
        Compress-Archive -Path "${{ github.workspace }}/packages/${packageName}" -DestinationPath "${{ github.workspace }}/packages/${packageName}.zip"
    
    - name: Install NSIS
      run: choco install nsis -y
    
    - name: Create NSIS script
      run: |
        $outputDir = "x64/${{ matrix.configuration }}"
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        $appName = "openopenwf"
        $appVersion = "1.0.0"
        $githubWorkspace = "${{ github.workspace }}"
        
        # Create NSIS script content
        $nsisContent = '; openopenwf Installer' + "`n"
        $nsisContent += '; Generated by GitHub Actions' + "`n`n"
        $nsisContent += '!include "MUI2.nsh"' + "`n`n"
        $nsisContent += '; Basic Settings' + "`n"
        $nsisContent += 'Name "' + $appName + '"' + "`n"
        $nsisContent += 'OutFile "' + $githubWorkspace + '/packages/' + $packageName + '-setup.exe"' + "`n"
        $nsisContent += 'InstallDir "$PROGRAMFILES64\\' + $appName + '"' + "`n"
        $nsisContent += 'RequestExecutionLevel admin' + "`n`n"
        $nsisContent += '; Modern UI Settings' + "`n"
        $nsisContent += '!define MUI_ABORTWARNING' + "`n`n"
        $nsisContent += '; Pages' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_WELCOME' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_LICENSE "' + $githubWorkspace + '/LICENSE"' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_DIRECTORY' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_INSTFILES' + "`n"
        $nsisContent += '!insertmacro MUI_PAGE_FINISH' + "`n`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_WELCOME' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_CONFIRM' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_INSTFILES' + "`n"
        $nsisContent += '!insertmacro MUI_UNPAGE_FINISH' + "`n`n"
        $nsisContent += '; Language' + "`n"
        $nsisContent += '!insertmacro MUI_LANGUAGE "English"' + "`n`n"
        $nsisContent += 'Section "MainSection" SEC01' + "`n"
        $nsisContent += '  SetOutPath "$INSTDIR"' + "`n`n"
        $nsisContent += '  ; Copy all files from the output directory' + "`n"
        $nsisContent += '  File /r "' + $githubWorkspace + '/' + $outputDir + '/*"' + "`n`n"
        $nsisContent += '  ; Create desktop shortcut' + "`n"
        $nsisContent += '  CreateShortCut "$DESKTOP\\' + $appName + '.lnk" "$INSTDIR\\openopenlauncher.exe"' + "`n`n"
        $nsisContent += '  ; Create start menu shortcut' + "`n"
        $nsisContent += '  CreateDirectory "$SMPROGRAMS\\' + $appName + '"' + "`n"
        $nsisContent += '  CreateShortCut "$SMPROGRAMS\\' + $appName + '\\' + $appName + '.lnk" "$INSTDIR\\openopenlauncher.exe"' + "`n"
        $nsisContent += '  CreateShortCut "$SMPROGRAMS\\' + $appName + '\\Uninstall.lnk" "$INSTDIR\\uninstall.exe"' + "`n"
        $nsisContent += 'SectionEnd' + "`n`n"
        $nsisContent += 'Section "Uninstall"' + "`n"
        $nsisContent += '  ; Delete desktop shortcut' + "`n"
        $nsisContent += '  Delete "$DESKTOP\\' + $appName + '.lnk"' + "`n`n"
        $nsisContent += '  ; Delete start menu shortcuts' + "`n"
        $nsisContent += '  Delete "$SMPROGRAMS\\' + $appName + '\\' + $appName + '.lnk"' + "`n"
        $nsisContent += '  Delete "$SMPROGRAMS\\' + $appName + '\\Uninstall.lnk"' + "`n"
        $nsisContent += '  RMDir "$SMPROGRAMS\\' + $appName + '"' + "`n`n"
        $nsisContent += '  ; Delete application files' + "`n"
        $nsisContent += '  RMDir /r "$INSTDIR"' + "`n"
        $nsisContent += 'SectionEnd' + "`n`n"
        $nsisContent += '; Generate uninstaller' + "`n"
        $nsisContent += 'WriteUninstaller "$INSTDIR\\uninstall.exe"' + "`n"
        
        # Write NSIS script to file
        $nsisContent | Out-File -FilePath "${{ github.workspace }}/packages/setup.nsi" -Encoding ASCII
    
    - name: Build installer with NSIS
      run: |
        $packageName = "openopenwf-${{ matrix.configuration }}-$(git rev-parse --short HEAD)"
        makensis "${{ github.workspace }}/packages/setup.nsi"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: openopenwf-${{ matrix.configuration }}
        path: |
          ${{ github.workspace }}/packages/*.zip
          ${{ github.workspace }}/packages/*-setup.exe
        retention-days: 14

  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: ${{ github.workspace }}/artifacts
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.workspace }}/artifacts/**/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}